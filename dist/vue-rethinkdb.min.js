/*!
 * vue-rethinkdb v1.0.9
 * (c) 2018 Chad Robinson
 * Released under the MIT License.
 */

!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t(e["vue-rethinkdb"]={})}(this,function(e){"use strict";var o=function(e,t){return(o=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(e,t)};function t(e,t){function n(){this.constructor=e}o(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}var n=function(e,t){this.target=t,this.type=e},r=function(o){function e(e,t){var n=o.call(this,"error",t)||this;return n.message=e.message,n.error=e,n}return t(e,o),e}(n),i=function(r){function e(e,t,n){void 0===e&&(e=1e3),void 0===t&&(t="");var o=r.call(this,"close",n)||this;return o.wasClean=!0,o.code=e,o.reason=t,o}return t(e,r),e}(n),a={maxReconnectionDelay:1e4,minReconnectionDelay:1e3+4e3*Math.random(),minUptime:5e3,reconnectionDelayGrowFactor:1.3,connectionTimeout:4e3,maxRetries:1/0,debug:!1},s=function(){function e(e,t,n){void 0===n&&(n={});var o=this;this._listeners={error:[],message:[],open:[],close:[]},this._retryCount=-1,this._shouldReconnect=!0,this._connectLock=!1,this._binaryType="blob",this._closeCalled=!1,this._messageQueue=[],this.onclose=void 0,this.onerror=void 0,this.onmessage=void 0,this.onopen=void 0,this._handleOpen=function(t){o._debug("open event");var e=o._options.minUptime,n=void 0===e?a.minUptime:e;clearTimeout(o._connectTimeout),o._uptimeTimeout=setTimeout(function(){return o._acceptOpen()},n),o._ws.binaryType=o._binaryType,o._messageQueue.forEach(function(e){return o._ws.send(e)}),o._messageQueue=[],o.onopen&&o.onopen(t),o._listeners.open.forEach(function(e){return o._callEventListener(t,e)})},this._handleMessage=function(t){o._debug("message event"),o.onmessage&&o.onmessage(t),o._listeners.message.forEach(function(e){return o._callEventListener(t,e)})},this._handleError=function(t){o._debug("error event",t.message),o._disconnect(void 0,"TIMEOUT"===t.message?"timeout":void 0),o.onerror&&o.onerror(t),o._debug("exec error listeners"),o._listeners.error.forEach(function(e){return o._callEventListener(t,e)}),o._connect()},this._handleClose=function(t){o._debug("close event"),o._clearTimeouts(),o._shouldReconnect&&o._connect(),o.onclose&&o.onclose(t),o._listeners.close.forEach(function(e){return o._callEventListener(t,e)})},this._url=e,this._protocols=t,this._options=n,this._connect()}return Object.defineProperty(e,"CONNECTING",{get:function(){return 0},enumerable:!0,configurable:!0}),Object.defineProperty(e,"OPEN",{get:function(){return 1},enumerable:!0,configurable:!0}),Object.defineProperty(e,"CLOSING",{get:function(){return 2},enumerable:!0,configurable:!0}),Object.defineProperty(e,"CLOSED",{get:function(){return 3},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"CONNECTING",{get:function(){return e.CONNECTING},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"OPEN",{get:function(){return e.OPEN},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"CLOSING",{get:function(){return e.CLOSING},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"CLOSED",{get:function(){return e.CLOSED},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"binaryType",{get:function(){return this._ws?this._ws.binaryType:this._binaryType},set:function(e){this._binaryType=e,this._ws&&(this._ws.binaryType=e)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"retryCount",{get:function(){return Math.max(this._retryCount,0)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"bufferedAmount",{get:function(){return this._messageQueue.reduce(function(e,t){return"string"==typeof t?e+=t.length:t instanceof Blob?e+=t.size:e+=t.byteLength,e},0)+(this._ws?this._ws.bufferedAmount:0)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"extensions",{get:function(){return this._ws?this._ws.extensions:""},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"protocol",{get:function(){return this._ws?this._ws.protocol:""},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"readyState",{get:function(){return this._ws?this._ws.readyState:e.CONNECTING},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"url",{get:function(){return this._ws?this._ws.url:""},enumerable:!0,configurable:!0}),e.prototype.close=function(e,t){void 0===e&&(e=1e3),this._closeCalled=!0,this._shouldReconnect=!1,this._clearTimeouts(),this._ws?this._ws.readyState!==this.CLOSED?this._ws.close(e,t):this._debug("close: already closed"):this._debug("close enqueued: no ws instance")},e.prototype.reconnect=function(e,t){this._shouldReconnect=!0,this._closeCalled=!1,this._retryCount=-1,this._ws&&this._ws.readyState!==this.CLOSED&&this._disconnect(e,t),this._connect()},e.prototype.send=function(e){this._ws&&this._ws.readyState===this.OPEN?(this._debug("send",e),this._ws.send(e)):(this._debug("enqueue",e),this._messageQueue.push(e))},e.prototype.addEventListener=function(e,t){this._listeners[e]&&this._listeners[e].push(t)},e.prototype.removeEventListener=function(e,t){this._listeners[e]&&(this._listeners[e]=this._listeners[e].filter(function(e){return e!==t}))},e.prototype._debug=function(){for(var e=arguments,t=[],n=0;n<arguments.length;n++)t[n]=e[n];this._options.debug&&console.log.apply(console,["RWS>"].concat(t))},e.prototype._getNextDelay=function(){var e=this._options,t=e.reconnectionDelayGrowFactor,n=void 0===t?a.reconnectionDelayGrowFactor:t,o=e.minReconnectionDelay,r=void 0===o?a.minReconnectionDelay:o,i=e.maxReconnectionDelay,s=void 0===i?a.maxReconnectionDelay:i,u=r;return 0<this._retryCount&&s<(u=r*Math.pow(n,this._retryCount-1))&&(u=s),this._debug("next delay",u),u},e.prototype._wait=function(){var t=this;return new Promise(function(e){setTimeout(e,t._getNextDelay())})},e.prototype._getNextUrl=function(e){if("string"==typeof e)return Promise.resolve(e);if("function"==typeof e){var t=e();if("string"==typeof t)return Promise.resolve(t);if(t.then)return t}throw Error("Invalid URL")},e.prototype._connect=function(){var t=this;if(!this._connectLock&&this._shouldReconnect){this._connectLock=!0;var e=this._options,n=e.maxRetries,o=void 0===n?a.maxRetries:n,r=e.connectionTimeout,i=void 0===r?a.connectionTimeout:r,s=e.WebSocket,u=void 0===s?function(){if("undefined"!=typeof WebSocket)return WebSocket}():s;if(this._retryCount>=o)this._debug("max retries reached",this._retryCount,">=",o);else{if(this._retryCount++,this._debug("connect",this._retryCount),this._removeListeners(),"function"!=typeof(c=u)||2!==c.CLOSING)throw Error("No valid WebSocket class provided");var c;this._wait().then(function(){return t._getNextUrl(t._url)}).then(function(e){t._closeCalled?t._connectLock=!1:(t._debug("connect",{url:e,protocols:t._protocols}),t._ws=t._protocols?new u(e,t._protocols):new u(e),t._ws.binaryType=t._binaryType,t._connectLock=!1,t._addListeners(),t._connectTimeout=setTimeout(function(){return t._handleTimeout()},i))})}}},e.prototype._handleTimeout=function(){this._debug("timeout event"),this._handleError(new r(Error("TIMEOUT"),this))},e.prototype._disconnect=function(e,t){if(void 0===e&&(e=1e3),this._clearTimeouts(),this._ws){this._removeListeners();try{this._ws.close(e,t),this._handleClose(new i(e,t,this))}catch(e){}}},e.prototype._acceptOpen=function(){this._debug("accept open"),this._retryCount=0},e.prototype._callEventListener=function(e,t){"handleEvent"in t?t.handleEvent(e):t(e)},e.prototype._removeListeners=function(){this._ws&&(this._debug("removeListeners"),this._ws.removeEventListener("open",this._handleOpen),this._ws.removeEventListener("close",this._handleClose),this._ws.removeEventListener("message",this._handleMessage),this._ws.removeEventListener("error",this._handleError))},e.prototype._addListeners=function(){this._ws&&(this._debug("addListeners"),this._ws.addEventListener("open",this._handleOpen),this._ws.addEventListener("close",this._handleClose),this._ws.addEventListener("message",this._handleMessage),this._ws.addEventListener("error",this._handleError))},e.prototype._clearTimeouts=function(){clearTimeout(this._connectTimeout),clearTimeout(this._uptimeTimeout)},e}(),u={rws:null,nextCid:1,nextQueryId:1,queries:{},requests:{},options:{url:"ws://localhost:8000/socketcluster",log:console},authToken:null,install:function(o,e){Object.assign(u.options,e||{},u.options),u.options.log.debug("RethinkDB: Starting driver",e),o.mixin({created:function(){var t=this,e=(t.$options||{}).rethinkDB;if(e){var n=e.call(this);t.$rethinkQueries=Object.keys(n).map(function(e){return u.registerField(o,t,e,n[e])})}},beforeDestroy:function(){u.unsubscribeAll(this)}}),u.rws=new s(u.options.url),u.rws.addEventListener("open",function(){u.options.log.debug("RethinkDB: Connection established, sending handshake..."),u.emitAck("#handshake").then(function(){return u.authenticate()}).then(function(){return u.subscribeAll()}).catch(function(e){return u.options.log.error("RethinkDB: Handshake failed",e)})}),u.rws.addEventListener("message",function(e){if("#1"!==e.data){var t=JSON.parse(e.data),n=u.requests[t.rid];if(n)return n.resolve(t.data),void delete u.requests[t.rid];"queryResponse"!==t.event?u.options.log.error("RethinkDB: Unhandled WebSocket message",t):u.processQueryResponse(t.data)}else u.rws.send("#2")}),setInterval(function(){var n=Date.now();Object.keys(u.requests).forEach(function(e){var t=u.requests[e];n>t.timestamp+3e3&&(u.options.log.error("Expired request",t.cid),delete u.requests[e],t.reject(new Error("Timed out")))})},1e3)},registerField:function(e,t,n,o){var r,i={queryId:u.nextQueryId++,vm:t,field:n,query:o.value||o.collection,params:o.params||{},state:"initializing",onStateChanged:o.onStateChanged||null,onValueChanged:o.onValueChanged||null,onEntryAdded:o.onEntryAdded||null,onEntryUpdated:o.onEntryUpdated||null,onEntryMoved:o.onEntryMoved||null,onEntryDeleted:o.onEntryDeleted||null};if(u.options.log.debug("RethinkDB: Registering field "+n,{config:o,query:i}),o.value)i.type="value",r={};else{if(!o.collection)throw new Error("Invalid query type for "+n+": must be value or collection.");i.type="collection",r=[]}return n in t?t[n]=r:e.util.defineReactive(t,n,r),u.queries[i.queryId]=i,u.subscribe(i),i},subscribeAll:function(){return u.options.log.debug("RethinkDB: Subscribing to all"),Object.keys(u.queries).forEach(function(e){return u.subscribe(u.queries[e])}),Promise.resolve(!0)},subscribe:function(e){u.options.log.debug("RethinkDB: Subscribing to query",e),u.rws.readyState===WebSocket.OPEN&&u.emit("subscribeQuery",{queryId:e.queryId,query:e.query,params:e.params})},unsubscribeAll:function(e){e.$rethinkQueries&&0<e.$rethinkQueries.length&&(u.options.log.debug("RethinkDB: Unsubscribing from all"),e.$rethinkQueries.forEach(u.unsubscribe),e.$rethinkQueries.length=0)},unsubscribe:function(e){u.options.log.debug("RethinkDB: Unsubscribing from query",e),"collection"===e.type?e.vm[e.field].length=0:"value"===e.type&&(e.vm[e.field]={}),delete u.queries[e.queryId],u.emit("unsubscribeQuery",{queryId:e.queryId})},processQueryResponse:function(e){var t=u.queries[e.queryId];t?"value"===t.type?u.processValueResponse(t,e.change):u.processCollectionResponse(t,e.change):u.options.log.error("RethinkDB: Ignoring query response for unknown queryId",e.change)},processValueResponse:function(e,t){u.options.log.debug("RethinkDB: Processing value response"),"state"===t.type?(e.state=t.state,u.options.log.debug("RethinkDB: Query "+e.queryId+" new state: "+e.state),e.onStateChanged&&e.onStateChanged.call(e.vm,e.state)):t.new_val&&(e.vm[e.field]=t.new_val,u.options.log.debug("RethinkDB: Query "+e.queryId+" new value: "+e.new_val),e.onValueChanged&&e.onValueChanged.call(e.vm,e.state,t.new_val))},processCollectionResponse:function(e,t){switch(t.type){case"remove":case"uninitial":if(null!=t.old_offset){var n=e.vm[e.field].splice(t.old_offset,1);e.onEntryDeleted&&e.onEntryDeleted.call(e.vm,e.state,n[0],t.old_offset)}else{var o=e.vm[e.field].findIndex(function(e){return e.id===t.old_val.id});if(-1===o)throw new Error("Unable to apply change: "+JSON.stringify(t));var r=e.vm[e.field].splice(o,1);e.onEntryDeleted&&e.onEntryDeleted.call(e.vm,e.state,r[0],o)}break;case"add":case"initial":null!=t.new_offset?(e.vm[e.field].splice(t.new_offset,0,t.new_val),e.onEntryAdded&&e.onEntryAdded.call(e.vm,e.state,t.new_val,t.new_offset)):(e.vm[e.field].push(t.new_val),e.onEntryAdded&&e.onEntryAdded.call(e.vm,e.state,t.new_val,e.vm[e.field].length-1));break;case"change":if(null!=t.old_offset&&e.vm[e.field].splice(t.old_offset,1),null!=t.new_offset)e.vm[e.field].splice(t.new_offset,0,t.new_val),e.onEntryUpdated&&e.onEntryUpdated.call(e.vm,e.state,t.new_val,t.new_offset);else{var i=e.vm[e.field].findIndex(function(e){return e.id===t.old_val.id});if(-1===i)throw new Error("Unable to apply change: "+JSON.stringify(t));e.vm[e.field][i]=t.new_val,e.onEntryUpdated&&e.onEntryUpdated.call(e.vm,e.state,t.new_val,i)}break;case"state":e.state=t.state,e.onStateChanged&&e.onStateChanged.call(e.vm,e.state);break;default:throw new Error('Unrecognized "type" field from server: '+JSON.stringify(t))}},authenticate:function(e){(e||null===e)&&(u.options.log.debug("RethinkDB: Storing auth token"),u.authToken=e),u.authToken&&u.rws&&u.rws.readyState===WebSocket.OPEN?(u.options.log.debug("RethinkDB: Authenticating..."),u.emitAck("auth",{authToken:u.authToken}).then(function(e){return u.options.log.log("Authenticated",e)}).catch(function(e){return u.options.log.error("Authentication error",e)})):u.options.log.debug("RethinkDB: Skipping authentication")},emit:function(e,t){if(u.rws.readyState===WebSocket.OPEN){var n={cid:u.nextCid++,event:e,data:t||{}};u.rws.send(JSON.stringify(n))}},emitAck:function(e,t){if(u.rws.readyState!==WebSocket.OPEN)return Promise.reject(new Error("Not connected."));var n={},o=u.nextCid++,r=new Promise(function(e,t){n.resolve=e,n.reject=t,n.timestamp=Date.now(),u.requests[o]=n}),i={cid:o,event:e,data:t||{}};return u.rws.send(JSON.stringify(i)),r}};e.default=u,Object.defineProperty(e,"__esModule",{value:!0})});