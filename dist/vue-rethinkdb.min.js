/*!
 * vue-rethinkdb v1.1.1
 * (c) 2020 Chad Robinson
 * Released under the MIT License.
 */

!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t(e["vue-rethinkdb"]={})}(this,function(e){"use strict";var o=function(e,t){return(o=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(e,t)};function t(e,t){function n(){this.constructor=e}o(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}function r(e,t){var n="function"==typeof Symbol&&e[Symbol.iterator];if(!n)return e;var o,r,i=n.call(e),s=[];try{for(;(void 0===t||0<t--)&&!(o=i.next()).done;)s.push(o.value)}catch(e){r={error:e}}finally{try{o&&!o.done&&(n=i.return)&&n.call(i)}finally{if(r)throw r.error}}return s}function n(e,t){this.target=t,this.type=e}var i,s=(t(u,i=n),u);function u(e,t){var n=i.call(this,"error",t)||this;return n.message=e.message,n.error=e,n}var a,l=(t(c,a=n),c);function c(e,t,n){void 0===e&&(e=1e3),void 0===t&&(t="");var o=a.call(this,"close",n)||this;return o.wasClean=!0,o.code=e,o.reason=t,o}var d={maxReconnectionDelay:1e4,minReconnectionDelay:1e3+4e3*Math.random(),minUptime:5e3,reconnectionDelayGrowFactor:1.3,connectionTimeout:4e3,maxRetries:1/0,maxEnqueuedMessages:1/0,startClosed:!1,debug:!1},h=(Object.defineProperty(f,"CONNECTING",{get:function(){return 0},enumerable:!0,configurable:!0}),Object.defineProperty(f,"OPEN",{get:function(){return 1},enumerable:!0,configurable:!0}),Object.defineProperty(f,"CLOSING",{get:function(){return 2},enumerable:!0,configurable:!0}),Object.defineProperty(f,"CLOSED",{get:function(){return 3},enumerable:!0,configurable:!0}),Object.defineProperty(f.prototype,"CONNECTING",{get:function(){return f.CONNECTING},enumerable:!0,configurable:!0}),Object.defineProperty(f.prototype,"OPEN",{get:function(){return f.OPEN},enumerable:!0,configurable:!0}),Object.defineProperty(f.prototype,"CLOSING",{get:function(){return f.CLOSING},enumerable:!0,configurable:!0}),Object.defineProperty(f.prototype,"CLOSED",{get:function(){return f.CLOSED},enumerable:!0,configurable:!0}),Object.defineProperty(f.prototype,"binaryType",{get:function(){return this._ws?this._ws.binaryType:this._binaryType},set:function(e){this._binaryType=e,this._ws&&(this._ws.binaryType=e)},enumerable:!0,configurable:!0}),Object.defineProperty(f.prototype,"retryCount",{get:function(){return Math.max(this._retryCount,0)},enumerable:!0,configurable:!0}),Object.defineProperty(f.prototype,"bufferedAmount",{get:function(){return this._messageQueue.reduce(function(e,t){return"string"==typeof t?e+=t.length:t instanceof Blob?e+=t.size:e+=t.byteLength,e},0)+(this._ws?this._ws.bufferedAmount:0)},enumerable:!0,configurable:!0}),Object.defineProperty(f.prototype,"extensions",{get:function(){return this._ws?this._ws.extensions:""},enumerable:!0,configurable:!0}),Object.defineProperty(f.prototype,"protocol",{get:function(){return this._ws?this._ws.protocol:""},enumerable:!0,configurable:!0}),Object.defineProperty(f.prototype,"readyState",{get:function(){return this._ws?this._ws.readyState:this._options.startClosed?f.CLOSED:f.CONNECTING},enumerable:!0,configurable:!0}),Object.defineProperty(f.prototype,"url",{get:function(){return this._ws?this._ws.url:""},enumerable:!0,configurable:!0}),f.prototype.close=function(e,t){void 0===e&&(e=1e3),this._closeCalled=!0,this._shouldReconnect=!1,this._clearTimeouts(),this._ws?this._ws.readyState!==this.CLOSED?this._ws.close(e,t):this._debug("close: already closed"):this._debug("close enqueued: no ws instance")},f.prototype.reconnect=function(e,t){this._shouldReconnect=!0,this._closeCalled=!1,this._retryCount=-1,this._ws&&this._ws.readyState!==this.CLOSED&&this._disconnect(e,t),this._connect()},f.prototype.send=function(e){if(this._ws&&this._ws.readyState===this.OPEN)this._debug("send",e),this._ws.send(e);else{var t=this._options.maxEnqueuedMessages,n=void 0===t?d.maxEnqueuedMessages:t;this._messageQueue.length<n&&(this._debug("enqueue",e),this._messageQueue.push(e))}},f.prototype.addEventListener=function(e,t){this._listeners[e]&&this._listeners[e].push(t)},f.prototype.dispatchEvent=function(e){var t,n,o=this._listeners[e.type];if(o)try{for(var r=function(e){var t="function"==typeof Symbol&&e[Symbol.iterator],n=0;return t?t.call(e):{next:function(){return e&&n>=e.length&&(e=void 0),{value:e&&e[n++],done:!e}}}}(o),i=r.next();!i.done;i=r.next()){var s=i.value;this._callEventListener(e,s)}}catch(e){t={error:e}}finally{try{i&&!i.done&&(n=r.return)&&n.call(r)}finally{if(t)throw t.error}}return!0},f.prototype.removeEventListener=function(e,t){this._listeners[e]&&(this._listeners[e]=this._listeners[e].filter(function(e){return e!==t}))},f.prototype._debug=function(){for(var e=arguments,t=[],n=0;n<arguments.length;n++)t[n]=e[n];this._options.debug&&console.log.apply(console,function(){for(var e=arguments,t=[],n=0;n<arguments.length;n++)t=t.concat(r(e[n]));return t}(["RWS>"],t))},f.prototype._getNextDelay=function(){var e=this._options,t=e.reconnectionDelayGrowFactor,n=void 0===t?d.reconnectionDelayGrowFactor:t,o=e.minReconnectionDelay,r=void 0===o?d.minReconnectionDelay:o,i=e.maxReconnectionDelay,s=void 0===i?d.maxReconnectionDelay:i,u=0;return 0<this._retryCount&&s<(u=r*Math.pow(n,this._retryCount-1))&&(u=s),this._debug("next delay",u),u},f.prototype._wait=function(){var t=this;return new Promise(function(e){setTimeout(e,t._getNextDelay())})},f.prototype._getNextUrl=function(e){if("string"==typeof e)return Promise.resolve(e);if("function"==typeof e){var t=e();if("string"==typeof t)return Promise.resolve(t);if(t.then)return t}throw Error("Invalid URL")},f.prototype._connect=function(){var t=this;if(!this._connectLock&&this._shouldReconnect){this._connectLock=!0;var e=this._options,n=e.maxRetries,o=void 0===n?d.maxRetries:n,r=e.connectionTimeout,i=void 0===r?d.connectionTimeout:r,s=e.WebSocket,u=void 0===s?function(){if("undefined"!=typeof WebSocket)return WebSocket}():s;if(this._retryCount>=o)this._debug("max retries reached",this._retryCount,">=",o);else{if(this._retryCount++,this._debug("connect",this._retryCount),this._removeListeners(),void 0===(a=u)||!a||2!==a.CLOSING)throw Error("No valid WebSocket class provided");var a;this._wait().then(function(){return t._getNextUrl(t._url)}).then(function(e){t._closeCalled||(t._debug("connect",{url:e,protocols:t._protocols}),t._ws=t._protocols?new u(e,t._protocols):new u(e),t._ws.binaryType=t._binaryType,t._connectLock=!1,t._addListeners(),t._connectTimeout=setTimeout(function(){return t._handleTimeout()},i))})}}},f.prototype._handleTimeout=function(){this._debug("timeout event"),this._handleError(new s(Error("TIMEOUT"),this))},f.prototype._disconnect=function(e,t){if(void 0===e&&(e=1e3),this._clearTimeouts(),this._ws){this._removeListeners();try{this._ws.close(e,t),this._handleClose(new l(e,t,this))}catch(e){}}},f.prototype._acceptOpen=function(){this._debug("accept open"),this._retryCount=0},f.prototype._callEventListener=function(e,t){"handleEvent"in t?t.handleEvent(e):t(e)},f.prototype._removeListeners=function(){this._ws&&(this._debug("removeListeners"),this._ws.removeEventListener("open",this._handleOpen),this._ws.removeEventListener("close",this._handleClose),this._ws.removeEventListener("message",this._handleMessage),this._ws.removeEventListener("error",this._handleError))},f.prototype._addListeners=function(){this._ws&&(this._debug("addListeners"),this._ws.addEventListener("open",this._handleOpen),this._ws.addEventListener("close",this._handleClose),this._ws.addEventListener("message",this._handleMessage),this._ws.addEventListener("error",this._handleError))},f.prototype._clearTimeouts=function(){clearTimeout(this._connectTimeout),clearTimeout(this._uptimeTimeout)},f);function f(e,t,n){var o=this;void 0===n&&(n={}),this._listeners={error:[],message:[],open:[],close:[]},this._retryCount=-1,this._shouldReconnect=!0,this._connectLock=!1,this._binaryType="blob",this._closeCalled=!1,this._messageQueue=[],this.onclose=null,this.onerror=null,this.onmessage=null,this.onopen=null,this._handleOpen=function(t){o._debug("open event");var e=o._options.minUptime,n=void 0===e?d.minUptime:e;clearTimeout(o._connectTimeout),o._uptimeTimeout=setTimeout(function(){return o._acceptOpen()},n),o._ws.binaryType=o._binaryType,o._messageQueue.forEach(function(e){return o._ws.send(e)}),o._messageQueue=[],o.onopen&&o.onopen(t),o._listeners.open.forEach(function(e){return o._callEventListener(t,e)})},this._handleMessage=function(t){o._debug("message event"),o.onmessage&&o.onmessage(t),o._listeners.message.forEach(function(e){return o._callEventListener(t,e)})},this._handleError=function(t){o._debug("error event",t.message),o._disconnect(void 0,"TIMEOUT"===t.message?"timeout":void 0),o.onerror&&o.onerror(t),o._debug("exec error listeners"),o._listeners.error.forEach(function(e){return o._callEventListener(t,e)}),o._connect()},this._handleClose=function(t){o._debug("close event"),o._clearTimeouts(),o._shouldReconnect&&o._connect(),o.onclose&&o.onclose(t),o._listeners.close.forEach(function(e){return o._callEventListener(t,e)})},this._url=e,this._protocols=t,this._options=n,this._options.startClosed&&(this._shouldReconnect=!1),this._connect()}var p={rws:null,nextCid:1,nextQueryId:1,queries:{},requests:{},options:{url:"ws://localhost:8000/socketcluster",log:console},authToken:null,install:function(o,e){Object.assign(p.options,e||{},p.options),p.options.log.debug("RethinkDB: Starting driver",e),o.mixin({created:function(){var t=this,e=(t.$options||{}).rethinkDB;if(e){var n=e.call(this);t.$rethinkQueries=Object.keys(n).map(function(e){return p.registerField(o,t,e,n[e])})}},beforeDestroy:function(){p.unsubscribeAll(this)}}),p.rws=new h(p.options.url),p.rws.addEventListener("open",function(){p.options.log.debug("RethinkDB: Connection established, sending handshake..."),p.emitAck("#handshake").then(function(){return p.authenticate()}).then(function(){return p.subscribeAll()}).catch(function(e){return p.options.log.error("RethinkDB: Handshake failed",e)})}),p.rws.addEventListener("message",function(e){if("#1"!==e.data){var t=JSON.parse(e.data),n=p.requests[t.rid];if(n)return n.resolve(t.data),void delete p.requests[t.rid];"queryResponse"!==t.event?p.options.log.error("RethinkDB: Unhandled WebSocket message",t):p.processQueryResponse(t.data)}else p.rws.send("#2")}),setInterval(function(){var n=Date.now();Object.keys(p.requests).forEach(function(e){var t=p.requests[e];n>t.timestamp+3e3&&(p.options.log.error("Expired request",t.cid),delete p.requests[e],t.reject(new Error("Timed out")))})},1e3)},registerField:function(e,t,n,o){var r,i={queryId:p.nextQueryId++,vm:t,field:n,query:o.value||o.collection,params:o.params||{},state:"initializing",onStateChanged:o.onStateChanged||null,onValueChanged:o.onValueChanged||null,onEntryAdded:o.onEntryAdded||null,onEntryUpdated:o.onEntryUpdated||null,onEntryMoved:o.onEntryMoved||null,onEntryDeleted:o.onEntryDeleted||null};if(p.options.log.debug("RethinkDB: Registering field "+n,{config:o,query:i}),o.value)i.type="value",r={};else{if(!o.collection)throw new Error("Invalid query type for "+n+": must be value or collection.");i.type="collection",r=[]}return n in t?t[n]=r:e.util.defineReactive(t,n,r),p.queries[i.queryId]=i,p.subscribe(i),i},subscribeAll:function(){return p.options.log.debug("RethinkDB: Subscribing to all"),Object.keys(p.queries).forEach(function(e){return p.subscribe(p.queries[e])}),Promise.resolve(!0)},subscribe:function(e){p.options.log.debug("RethinkDB: Subscribing to query",e),p.rws.readyState===WebSocket.OPEN&&p.emit("subscribeQuery",{queryId:e.queryId,query:e.query,params:e.params})},unsubscribeAll:function(e){e.$rethinkQueries&&0<e.$rethinkQueries.length&&(p.options.log.debug("RethinkDB: Unsubscribing from all"),e.$rethinkQueries.forEach(p.unsubscribe),e.$rethinkQueries.length=0)},unsubscribe:function(e){p.options.log.debug("RethinkDB: Unsubscribing from query",e),"collection"===e.type?e.vm[e.field].length=0:"value"===e.type&&(e.vm[e.field]={}),delete p.queries[e.queryId],p.emit("unsubscribeQuery",{queryId:e.queryId})},processQueryResponse:function(e){var t=p.queries[e.queryId];t?"value"===t.type?p.processValueResponse(t,e.change):p.processCollectionResponse(t,e.change):p.options.log.error("RethinkDB: Ignoring query response for unknown queryId",e.change)},processValueResponse:function(e,t){p.options.log.debug("RethinkDB: Processing value response"),"state"===t.type?(e.state=t.state,p.options.log.debug("RethinkDB: Query "+e.queryId+" new state: "+e.state),e.onStateChanged&&e.onStateChanged.call(e.vm,e.state)):t.new_val&&(e.vm[e.field]=t.new_val,p.options.log.debug("RethinkDB: Query "+e.queryId+" new value: "+e.new_val),e.onValueChanged&&e.onValueChanged.call(e.vm,e.state,t.new_val))},processCollectionResponse:function(e,t){switch(t.type){case"remove":case"uninitial":if(null!=t.old_offset){var n=e.vm[e.field].splice(t.old_offset,1);e.onEntryDeleted&&e.onEntryDeleted.call(e.vm,e.state,n[0],t.old_offset)}else{var o=e.vm[e.field].findIndex(function(e){return e.id===t.old_val.id});if(-1===o)throw new Error("Unable to apply change: "+JSON.stringify(t));var r=e.vm[e.field].splice(o,1);e.onEntryDeleted&&e.onEntryDeleted.call(e.vm,e.state,r[0],o)}break;case"add":case"initial":null!=t.new_offset?(e.vm[e.field].splice(t.new_offset,0,t.new_val),e.onEntryAdded&&e.onEntryAdded.call(e.vm,e.state,t.new_val,t.new_offset)):(e.vm[e.field].push(t.new_val),e.onEntryAdded&&e.onEntryAdded.call(e.vm,e.state,t.new_val,e.vm[e.field].length-1));break;case"change":if(null!=t.old_offset&&e.vm[e.field].splice(t.old_offset,1),null!=t.new_offset)e.vm[e.field].splice(t.new_offset,0,t.new_val),e.onEntryUpdated&&e.onEntryUpdated.call(e.vm,e.state,t.new_val,t.new_offset);else{var i=e.vm[e.field].findIndex(function(e){return e.id===t.old_val.id});if(-1===i)throw new Error("Unable to apply change: "+JSON.stringify(t));e.vm[e.field][i]=t.new_val,e.onEntryUpdated&&e.onEntryUpdated.call(e.vm,e.state,t.new_val,i)}break;case"state":e.state=t.state,"initializing"===e.state&&(e.vm[e.field].length=0),e.onStateChanged&&e.onStateChanged.call(e.vm,e.state);break;default:throw new Error('Unrecognized "type" field from server: '+JSON.stringify(t))}},authenticate:function(e){!e&&null!==e||(p.options.log.debug("RethinkDB: Storing auth token"),p.authToken=e),p.authToken&&p.rws&&p.rws.readyState===WebSocket.OPEN?(p.options.log.debug("RethinkDB: Authenticating..."),p.emitAck("auth",{authToken:p.authToken}).then(function(e){return p.options.log.log("Authenticated",e)}).catch(function(e){return p.options.log.error("Authentication error",e)})):p.options.log.debug("RethinkDB: Skipping authentication")},emit:function(e,t){if(p.rws.readyState===WebSocket.OPEN){var n={cid:p.nextCid++,event:e,data:t||{}};p.rws.send(JSON.stringify(n))}},emitAck:function(e,t){if(p.rws.readyState!==WebSocket.OPEN)return Promise.reject(new Error("Not connected."));var n={},o=p.nextCid++,r=new Promise(function(e,t){n.resolve=e,n.reject=t,n.timestamp=Date.now(),p.requests[o]=n}),i={cid:o,event:e,data:t||{}};return p.rws.send(JSON.stringify(i)),r}};e.default=p,Object.defineProperty(e,"__esModule",{value:!0})});