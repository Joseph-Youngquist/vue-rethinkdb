/*!
 * vue-rethinkdb v1.0.5
 * (c) 2018 Chad Robinson
 * Released under the MIT License.
 */

!function(e,n){"object"==typeof exports&&"undefined"!=typeof module?n(exports):"function"==typeof define&&define.amd?define(["exports"],n):n(e.VueRethinkdb=e.VueRethinkdb||{})}(this,function(e){"use strict";var o=function(e){return e&&2===e.CLOSING},r=function(){return{constructor:"undefined"!=typeof WebSocket&&o(WebSocket)?WebSocket:null,maxReconnectionDelay:1e4,minReconnectionDelay:1500,reconnectionDelayGrowFactor:1.3,connectionTimeout:4e3,maxRetries:1/0,debug:!1}},w=function(n,e,t){Object.defineProperty(e,t,{get:function(){return n[t]},set:function(e){n[t]=e},enumerable:!0,configurable:!0})},k=function(e){return e.minReconnectionDelay+Math.random()*e.minReconnectionDelay},E=["onopen","onclose","onmessage","onerror"],i=function(s,a,n){var d,l,c=this;void 0===n&&(n={});var f=0,v=0,y=!0,p=null,h={};if(!(this instanceof i))throw new TypeError("Failed to construct 'ReconnectingWebSocket': Please use the 'new' operator");var g=r();if(Object.keys(g).filter(function(e){return n.hasOwnProperty(e)}).forEach(function(e){return g[e]=n[e]}),!o(g.constructor))throw new TypeError("Invalid WebSocket constructor. Set `options.constructor`");var m=g.debug?function(){for(var e=arguments,n=[],t=0;t<arguments.length;t++)n[t]=e[t];return console.log.apply(console,["RWS:"].concat(n))}:function(){},u=function(e,t){return setTimeout(function(){var n=new Error(t);n.code=e,Array.isArray(h.error)&&h.error.forEach(function(e){return(0,e[0])(n)}),d.onerror&&d.onerror(n)},0)},b=function(){var e,n;(m("handleClose",{shouldRetry:y}),m("retries count:",++v),v>g.maxRetries)?u("EHOSTDOWN","Too many failed connection attempts"):(f?(n=f*(e=g).reconnectionDelayGrowFactor,f=n>e.maxReconnectionDelay?e.maxReconnectionDelay:n):f=k(g),m("handleClose - reconnectDelay:",f),y&&setTimeout(t,f))},t=function(){if(y){m("connect");var r,n,e,t=d,o="function"==typeof s?s():s;for(var i in d=new g.constructor(o,a),l=setTimeout(function(){m("timeout"),d.close(),u("ETIMEDOUT","Connection timeout")},g.connectionTimeout),m("bypass properties"),d)["addEventListener","removeEventListener","close","send"].indexOf(i)<0&&w(d,c,i);d.addEventListener("open",function(){clearTimeout(l),m("open"),f=k(g),m("reconnectDelay:",f),v=0}),d.addEventListener("close",b),r=d,n=t,e=h,Object.keys(e).forEach(function(o){e[o].forEach(function(e){var n=e[0],t=e[1];r.addEventListener(o,n,t)})}),n&&E.forEach(function(e){r[e]=n[e]}),d.onclose=d.onclose||p,p=null}};m("init"),t(),this.close=function(e,n,t){void 0===e&&(e=1e3),void 0===n&&(n="");var o=void 0===t?{}:t,r=o.keepClosed,i=void 0!==r&&r,s=o.fastClose,a=void 0===s||s,l=o.delay,c=void 0===l?0:l;if(m("close - params:",{reason:n,keepClosed:i,fastClose:a,delay:c,retriesCount:v,maxRetries:g.maxRetries}),y=!i&&v<=g.maxRetries,c&&(f=c),d.close(e,n),a){var u={code:e,reason:n,wasClean:!0};b(),d.removeEventListener("close",b),Array.isArray(h.close)&&h.close.forEach(function(e){var n=e[0],t=e[1];n(u),d.removeEventListener("close",n,t)}),d.onclose&&(p=d.onclose,d.onclose(u),d.onclose=null)}},this.send=function(e){d.send(e)},this.addEventListener=function(e,n,t){Array.isArray(h[e])?h[e].some(function(e){return e[0]===n})||h[e].push([n,t]):h[e]=[[n,t]],d.addEventListener(e,n,t)},this.removeEventListener=function(e,n,t){Array.isArray(h[e])&&(h[e]=h[e].filter(function(e){return e[0]!==n})),d.removeEventListener(e,n,t)}},n=i,s={rws:null,nextCid:1,nextQueryId:1,queries:{},requests:{},options:{url:"ws://localhost:8000/socketcluster",log:console},authToken:null,install:function(o,e){Object.assign(s.options,e||{},s.options),s.options.log.debug("RethinkDB: Starting driver",e),o.mixin({created:function(){var n=this,e=(n.$options||{}).rethinkDB;if(e){var t=e.call(this);n.$rethinkQueries=Object.keys(t).map(function(e){return s.registerField(o,n,e,t[e])})}},beforeDestroy:function(){s.unsubscribeAll(this)}}),s.rws=new n(s.options.url),s.rws.addEventListener("open",function(){s.options.log.debug("RethinkDB: Connection established, sending handshake..."),s.emitAck("#handshake").then(function(){return s.authenticate()}).then(function(){return s.subscribeAll()}).catch(function(e){return s.options.log.error("RethinkDB: Handshake failed",e)})}),s.rws.addEventListener("message",function(e){if("#1"!==e.data){var n=JSON.parse(e.data),t=s.requests[n.rid];if(t)return t.resolve(n.data),void delete s.requests[n.rid];"queryResponse"!==n.event?s.options.log.error("RethinkDB: Unhandled WebSocket message",n):s.processQueryResponse(n.data)}else s.rws.send("#2")}),setInterval(function(){var t=Date.now();Object.keys(s.requests).forEach(function(e){var n=s.requests[e];t>n.timestamp+3e3&&(s.options.log.error("Expired request",n.cid),delete s.requests[e],n.reject(new Error("Timed out")))})},1e3)},registerField:function(e,n,t,o){var r,i={queryId:s.nextQueryId++,vm:n,field:t,query:o.query||o.collection,params:o.params||{},state:"initializing",onStateChanged:o.onStateChanged||null,onValueChanged:o.onValueChanged||null,onEntryAdded:o.onEntryAdded||null,onEntryUpdated:o.onEntryUpdated||null,onEntryMoved:o.onEntryMoved||null,onEntryDeleted:o.onEntryDeleted||null};if(s.options.log.debug("RethinkDB: Registering field "+t,{config:o,query:i}),o.value)i.type="value",r={};else{if(!o.collection)throw new Error("Invalid query type for "+t+": must be value or collection.");i.type="collection",r=[]}return t in n?n[t]=r:e.util.defineReactive(n,t,r),s.queries[i.queryId]=i,s.subscribe(i),i},subscribeAll:function(){return s.options.log.debug("RethinkDB: Subscribing to all"),Object.keys(s.queries).forEach(function(e){return s.subscribe(s.queries[e])}),Promise.resolve(!0)},subscribe:function(e){s.options.log.debug("RethinkDB: Subscribing to query",e),s.rws.readyState===WebSocket.OPEN&&s.emit("subscribeQuery",{queryId:e.queryId,query:e.query,params:e.params})},unsubscribeAll:function(e){s.options.log.debug("RethinkDB: Unsubscribing from all"),e.$rethinkQueries&&(e.$rethinkQueries.forEach(s.unsubscribe),e.$rethinkQueries.length=0)},unsubscribe:function(e){s.options.log.debug("RethinkDB: Unsubscribing from query",e),"collection"===e.type?e.vm[e.field].length=0:"value"===e.type&&(e.vm[e.field]={}),delete s.queries[e.queryId],s.emit("unsubscribeQuery",{queryId:e.queryId})},processQueryResponse:function(e){var n=s.queries[e.queryId];n?"value"===n.type?s.processValueResponse(n,e.change):s.processCollectionResponse(n,e.change):s.options.log.error("RethinkDB: Ignoring query response for unknown queryId",e.change)},processValueResponse:function(e,n){s.options.log.debug("RethinkDB: Processing value response"),"state"===n.type?(e.state=n.state,s.options.log.debug("RethinkDB: Query "+e.queryId+" new state: "+e.state),e.onStateChanged&&e.onStateChanged.call(e.vm,e.state)):n.new_val&&(e.vm[e.field]=n.new_val,s.options.log.debug("RethinkDB: Query "+e.queryId+" new value: "+e.new_val),e.onValueChanged&&e.onValueChanged.call(e.vm,e.state,n.new_val))},processCollectionResponse:function(e,n){switch(n.type){case"remove":case"uninitial":if(null!=n.old_offset){var t=e.vm[e.field].splice(n.old_offset,1);e.onEntryDeleted&&e.onEntryDeleted.call(e.vm,e.state,t[0],n.old_offset)}else{var o=e.vm[e.field].findIndex(function(e){return e.id===n.old_val.id});if(-1===o)throw new Error("Unable to apply change: "+JSON.stringify(n));var r=e.vm[e.field].splice(o,1);e.onEntryDeleted&&e.onEntryDeleted.call(e.vm,e.state,r[0],o)}break;case"add":case"initial":null!=n.new_offset?(e.vm[e.field].splice(n.new_offset,0,n.new_val),e.onEntryAdded&&e.onEntryAdded.call(e.vm,e.state,n.new_val,n.new_offset)):(e.vm[e.field].push(n.new_val),e.onEntryAdded&&e.onEntryAdded.call(e.vm,e.state,n.new_val,e.vm[e.field].length-1));break;case"change":if(null!=n.old_offset&&e.vm[e.field].splice(n.old_offset,1),null!=n.new_offset)e.vm[e.field].splice(n.new_offset,0,n.new_val),e.onEntryUpdated&&e.onEntryUpdated.call(e.vm,e.state,n.new_val,n.new_offset);else{var i=e.vm[e.field].findIndex(function(e){return e.id===n.old_val.id});if(-1===i)throw new Error("Unable to apply change: "+JSON.stringify(n));e.vm[e.field][i]=n.new_val,e.onEntryUpdated&&e.onEntryUpdated.call(e.vm,e.state,n.new_val,i)}break;case"state":e.state=n.state,e.onStateChanged&&e.onStateChanged.call(e.vm,e.state);break;default:throw new Error('Unrecognized "type" field from server: '+JSON.stringify(n))}},authenticate:function(e){(e||null===e)&&(s.options.log.debug("RethinkDB: Storing auth token"),s.authToken=e),s.authToken&&s.rws&&s.rws.readyState===WebSocket.OPEN?(s.options.log.debug("RethinkDB: Authenticating..."),s.emitAck("auth",{authToken:s.authToken}).then(function(e){return s.options.log.log("Authenticated",e)}).catch(function(e){return s.options.log.error("Authentication error",e)})):s.options.log.debug("RethinkDB: Skipping authentication")},emit:function(e,n){if(s.rws.readyState===WebSocket.OPEN){var t={cid:s.nextCid++,event:e,data:n||{}};s.rws.send(JSON.stringify(t))}},emitAck:function(e,n){if(s.rws.readyState!==WebSocket.OPEN)return Promise.reject(new Error("Not connected."));var t={},o=s.nextCid++,r=new Promise(function(e,n){t.resolve=e,t.reject=n,t.timestamp=Date.now(),s.requests[o]=t}),i={cid:o,event:e,data:n||{}};return s.rws.send(JSON.stringify(i)),r}};e.default=s,Object.defineProperty(e,"__esModule",{value:!0})});